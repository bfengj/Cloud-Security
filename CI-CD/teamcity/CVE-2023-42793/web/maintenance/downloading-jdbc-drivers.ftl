[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include "maintenance-stuff.ftl"]

[@maintenancePage title="Downloading JDBC drivers"]

[#-- The unique (among all start-up pages) Id of the refreshable container. --]
  [#assign containerId = "driver-download-progress-section"]

<div id="${containerId}">
  [#if specificInfo.driverDownloadProgress??]
    [#assign driverDownloadProgress = specificInfo.driverDownloadProgress]
      <p>
        [#assign percent = driverDownloadProgress.percent]
        [#assign completed = percent == 100]
      [#-- Can't use ?then(...) here as it's available since FreeMarker 2.3.23,
      and we're running 2.3.19. --]
          TeamCity [#if completed]has downloaded[#else]is downloading[/#if] the
          JDBC driver for your database.<br/>
      ${driverDownloadProgress.phase}<br/>
          Download progress: <strong>${percent}%</strong><br/>
      </p>
  [#else]
      <p>
          The JDBC driver will start downloading shortly...
      </p>
  [/#if]
</div>

  [#if pageDebugging]
    [#assign pageUrl = "${webPrefix}/mnt/debug/page/downloading-jdbc-drivers"]
  [#else]
    [#assign pageUrl = "${webPrefix}/mnt"]
  [/#if]

<script type="application/javascript">
    BS.Maintenance.DriverDownloadProgressRefresher = {
        doRefresh: function () {
            "use strict";
            $.get("${pageUrl}", function(/**String*/ data) {
                var /**Object*/ receivedPage = $(data);
                var /**Object*/ refreshingDiv = receivedPage.find("#${containerId}");
                if (refreshingDiv.length > 0) {
                    /*
                     * Will only refresh if this page is the current one (i. e.
                     * it's accessible at http://localhost/mnt and contains the
                     * <div/> element with the given id).
                     */
                    $("#${containerId}").replaceWith(refreshingDiv);
                    BS.Maintenance.DriverDownloadProgressRefresher.scheduleRefresh();
                }
            });
        },

        scheduleRefresh: function () {
            "use strict";
            window.setTimeout(BS.Maintenance.DriverDownloadProgressRefresher.doRefresh, 1000);
        }
    };

    (function () {
        "use strict";
        BS.Maintenance.DriverDownloadProgressRefresher.scheduleRefresh();
    })();
</script>

[/@maintenancePage]
