[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include 'maintenance-stuff.ftl']

[@maintenancePage title='${serverName} has failed to start']
[#escape text as text?html]


[#if exceptionsDetailsExist]
  <h2>Error Details</h2>
  <div class="clearfix">
    <button id="copyButton" class="btn tc-icon_before icon16 tc-icon_copy" data-for="#copytext">Copy to clipboard</button>
    <div id="copyConfirmation">Stacktrace copied</div>
    <div id="safariCopy">Press &#8984;-C to copy</div>
  </div>
  <div id="copytext" class="exception-stack-trace mono mono-12px">
    [#list exceptionsDetails as stackTrace]
      <pre>${stackTrace}</pre>
    [/#list]
  </div>

  <script type="text/javascript">
      (function() {
        var cb = BS.Clipboard('#copyButton', {
            text: function(trigger) {
                return document.querySelector(trigger.getAttribute('data-for')).innerHTML
                        .replace(/&nbsp;/ig, ' ')
                        .replace(/<br>/ig, '');
            },
            skipDefaultHandlers: true
        });

        cb.on('success', function() {
            document.getElementById('copyConfirmation').style.display = 'inline-block';
        });
        cb.on('error', function() {
            document.getElementById('safariCopy').style.display = 'inline-block';
        });
      })();
  </script>
  <br/>
[/#if]

<h2>Current Startup State</h2>

<h3>Startup status</h3>
<div class="info-section">
  Current step: ${ctx.currStage.description} <br/>
  Next step: [#if ctx.nextStage??]
                 ${ctx.nextStage.description}
             [#else]
                 <span style="color: gray">not defined yet</span>
             [/#if]<br/>

  [#if ctx.shutdownRequested]
    System shutdown was requested<br/>
  [/#if]
</div>

<h3>Data Directory</h3>
<div class="info-section">
  [#if ctx.dataDirSpecified]
    <p>Directory path: <span class="mono mono-12px">${ctx.dataDirManager.rootDir}</span> ${ctx.dataDirManager.rootDirExist?string("exists","not found")}</p>
    [#if ctx.databaseExplicitlyConfigured]
      [#noescape]
      <p>Database is ${ctx.databasePropertiesFile.getExplicitConnectionDescription(true)}</p>
      [/#noescape]
    [#else]
      <p>Database properties file ${ctx.databasePropertiesFileExists?string('exists','not found')}, environment variables are not provided</p>
    [/#if]
    <p>Internal database file: ${ctx.internalDatabaseFileVersion!'not found'}</p>
  [#else]
    <p>Data Directory path is not specified/detected yet</p>
  [/#if]
</div>

<h3>Database</h3>
<div class="info-section">
  [#if ctx.databaseManager??]
    [#assign dbm=ctx.databaseManager]
    <p>Database type: [#if ctx.databaseExternal]${dbm.databaseType}[#else]default (using internal database)[/#if]</p>
    <p>Database connection URL: <span class="mono mono-12px" style="white-space: pre">${dbm.connectionString}</span></p>
    [#if ctx.databaseManager.driverVersion.notZero]
        <p>JDBC driver version: ${ctx.databaseManager.driverVersion} (${ctx.databaseManager.driverName})</p>
    [/#if]
    [#if ctx.databaseManager.databaseProductVersion.notZero]
        <p>Database system version: ${ctx.databaseManager.databaseProductVersion} (${ctx.databaseManager.databaseProductName})</p>
    [/#if]
  [#else]
    <p>Not connected to the database yet.</p>
  [/#if]
</div>

<h3>Versions</h3>
<div class="info-section">
  <p>Software version: [@version num=ctx.softwareVersion/]</p>
  <p>Data directory version: [@version num=ctx.dataDirVersion/]</p>
  <p>Database version: [@version num=ctx.databaseVersion/] ${ctx.databaseVersionIsGuessed?string("(guessed)", "")}</p>
</div>

[@loginfo/]

[/#escape]
[/@maintenancePage]
