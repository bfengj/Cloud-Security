[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include 'maintenance-stuff.ftl']

[@maintenancePage title='${serverName} Data Backup']

<div id="backup-progress-section">
  [#if specificInfo.backupProgressInfo??]
    <p>
      TeamCity Data backup is in progress.<br/>
      Backup phase: <strong>${specificInfo.backupProgressInfo.phase}</strong><br/>
      Backup progress: <strong>${specificInfo.backupProgressInfo.percent}%</strong><br/>
    </p>
  [#else]
    <p>
      Backup will start shortly...
    </p>
  [/#if]
</div>

<p>
  Upgrade will start automatically when the backup ends.
</p>

<script type="text/javascript">

  BS.Maintenance.BackupProgressRefresher = {
    doRefresh: function() {
      $.get('${webPrefix}/mnt', function(data) {

        var receivedPage = $(data);
        var refreshingDiv = receivedPage.find('#backup-progress-section');
        if (refreshingDiv.length > 0) {
          $('#backup-progress-section').replaceWith(refreshingDiv);
          BS.Maintenance.BackupProgressRefresher.scheduleRefresh();
        }
      });
    },

    scheduleRefresh: function() {
      window.setTimeout(BS.Maintenance.BackupProgressRefresher.doRefresh, 3000);
    }
  };

  BS.Maintenance.BackupProgressRefresher.scheduleRefresh();

</script>


[/@maintenancePage]
