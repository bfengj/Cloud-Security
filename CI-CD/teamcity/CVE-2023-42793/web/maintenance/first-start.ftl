[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include 'maintenance-stuff.ftl']

[@maintenancePage title="${serverName} First Start" showStageStatus=false]

    [#if ctx.selectedDirError??]
      <div class="error">${ctx.selectedDirError}</div>
    [/#if]

  <p>Please review the settings below before proceeding with the first TeamCity start.</p>

  <p>
    TeamCity server stores server configuration settings, project definitions, build results and caches on disk in a <b>Data Directory</b>.[@helpIcon link='TeamCity+Data+Directory'/]
  </p>

  [#if ctx.allowOverrideDataDirectory]
    <p>
    [#if ctx.dataDirSpecified]
        Data Directory location on the TeamCity server machine: <span><input id="data-directory-location" value="${ctx.suggestedFirstStartDataDirectoryPath}"/></span>
    [#else]
        Data Directory location on the TeamCity server machine: <span><input id="data-directory-location" /></span>
    [/#if]
    </p>
    <p>
      If you have already worked with TeamCity on this machine, you can specifiy an existing Data Directory.
    </p>

  [#else]
    <p>
      [#if ctx.dataDirSpecified]
        Location of the Data Directory: <b><span class="mono mono-12px">${ctx.dataDirManager.rootDir}</span></b>
      [#else]
        Data Directory path is not specified/detected yet
      [/#if]
    </p>
    <p>
        If you have already worked with TeamCity and want to use an existing directory or you want to use another location for creating fresh setup, check the
      [@helpLink link="TeamCity+Data+Directory#TeamCityDataDirectory-ConfiguringtheLocation"]documentation[/@helpLink] to change the directory location.
    </p>
  [/#if]

<div class="hidden">
  [@sysinfo/]
</div>

<div class="action-block">
  <input type="submit"
         id="restoreButton"
         class="btn btn_enable_on_load"
         onclick="BS.Maintenance.FirstStart.submit(true);"
         value="Restore from backup"
         disabled="disabled" />
  <input type="submit"
       id="proceedButton"
       class="btn btn_primary btn_enable_on_load"
       onclick="BS.Maintenance.FirstStart.submit(false);"
       value="Proceed"
       disabled="disabled" />
</div>

[/@maintenancePage]

<script type="text/javascript">
    BS.Maintenance.FirstStart = {

        getInputField: function() {
          return $("#data-directory-location");
        },

        submit: function(retoreFlag) {
            var dataDirInput = BS.Maintenance.FirstStart.getInputField();
            if (dataDirInput && dataDirInput.val()) {
                BS.Maintenance.postCommandAndRefresh('goNewInstallation', {dataDirPath: dataDirInput.val(), restore: retoreFlag});
            } else {
                BS.Maintenance.postCommandAndRefresh('goNewInstallation', {restore: retoreFlag});
            }
            return false;
        }
    };

    var inputField = BS.Maintenance.FirstStart.getInputField();
    if (inputField) {
        inputField.on("change keyup input paste cut", function() {
            if ($("#data-directory-location").val()) {
                $("#proceedButton").removeAttr('disabled');
                $("#restoreButton").removeAttr('disabled');
            } else {
                $("#proceedButton").attr('disabled','disabled');
                $("#restoreButton").attr('disabled','disabled');
            }
        });
    }

</script>

<style type="text/css">
  .btn {
    margin-right: 1ex;
  }
</style>