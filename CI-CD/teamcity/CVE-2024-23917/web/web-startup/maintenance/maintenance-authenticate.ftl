[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include 'maintenance-stuff.ftl']

[@maintenancePage title='${serverName} Maintenance']

<script type="text/javascript">
  BS.Maintenance.AuthForm = {

    authenticate: function() {
      var theTokenInput = $("#maintenance-authentication-token");
      theTokenInput.prop("disabled", true);
      var token = theTokenInput.val();
      var url = "${webPrefix}/mnt/do/authenticate";
      $.ajax(url, {
        type:'POST',
        data:{
          token:token
        },
        success:function (ajaxResult) {
          BS.Maintenance.AuthForm.processAuthenticationResult(ajaxResult);
        },
        error:function (xhr, status, error) {
          BS.Maintenance.AuthForm.processAjaxFailure("HTTP error " + status + ": " + error);
        },
        timeout:function () {
          BS.Maintenance.AuthForm.processAjaxFailure("The server is not accessible");
        }
      });
    },

    processAuthenticationResult: function(ajaxResult) {
      if (ajaxResult == "OK") {
        window.location.reload(true);
      }
      else {
        this.processAjaxFailure(ajaxResult);
      }
    },

    processAjaxFailure: function (errorMessage) {
      $("#error-message-text").text(errorMessage);
      $("#error-message").removeClass("hidden");
      var theTokenInput = $("#maintenance-authentication-token");
      theTokenInput.prop("disabled", false);
    }
  };

</script>

<div id="admin-login-panel">
  <form autocomplete="off" onsubmit="BS.Maintenance.AuthForm.authenticate(); return false;" class="token-form">
        <label for="maintenance-authentication-token" class="token-input-label">Enter the Super User token: </label>
        <div class="token-input">
          <input id="maintenance-authentication-token"
                 name="maintenance-authentication-token"
                 autocomplete="off"
                 maxlength="24"
                 onclick=""
               />
            <p id="error-message" class="hidden">
                <span id="error-message-text" style="color: var(--ring-error-color)"> </span>
            </p>
            <div><span class="note">The Super User token can be found in the <span class="mono">&lt;TeamCity Server home&gt;/logs/teamcity-server.log</span></span></div>
        </div>
        <div class="action-block">
            <input id="submit-token" type="submit" class="btn btn_primary submit-button" value="Confirm"/>
            <a class="cancel" href="[#if session.redirectedFrom??]${session.redirectedFrom}[#else]${webPrefix}/overview.html[/#if]">Cancel</a>
        </div>


  </form>
</div>

<script type="text/javascript">
  $('#maintenance-authentication-token').focus();
</script>

[/@maintenancePage]
