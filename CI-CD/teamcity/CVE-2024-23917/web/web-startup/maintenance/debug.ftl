[#ftl]
[#-- @ftlvariable name="" type="jetbrains.buildServer.maintenance.StartupPageModel" --]

[#include 'maintenance-stuff.ftl']

[@maintenancePage title='${serverName} Startup Debug']
[#escape text as text?html]


[#if ctx.currStage.name() = 'READY']
  <p>
  Welcome to the <b><a href="${webPrefix}/overview.html">Overview</a></b> page.
  </p>
[/#if]

[#if debug??]

<h3>Startup Status</h3>

<div class="info-section">
  Current Stage: ${ctx.currStage.name()} <br/>
  Next Stage: [#if ctx.nextStage??] ${ctx.nextStage.name()} [#else]<font color="gray">(not set yet)</font>[/#if] <br/>
  Context state revision: ${ctx.stateRevision} <br/>
  [#if ctx.shutdownRequested] Will shut down <br/> [/#if]
</div>

[@sysinfo/]

<h3>Other Context Data</h3>

<div class="info-section">
<style type="text/css">
    .debug-table td {
        vertical-align: top;
    }
    .debug-table td:first-child {
        white-space: nowrap;
    }
</style>
<table class="debug-table">
  <tr> <td>First start:</td> <td>${ctx.isFirstStart()?string('yes','no')}</td> </tr>
  <tr> <td>Database settings were specified from web UI:</td> <td>${ctx.databaseSettingsFromUISpecified?string('yes','no')}</td>  </tr>
  <tr> <td>Database properties file exists:</td> <td>${ctx.databasePropertiesFileExists?string('yes','no')}</td> </tr>
  <tr> <td>Database configuration is present:</td> <td>${ctx.databaseExplicitlyConfigured?string('yes','no')}</td> </tr>
  <tr> <td>Internals database file:</td> <td>${ctx.internalDatabaseFileVersion!'not found'}</td> </tr>

  [#if ctx.databaseManager?? && ctx.databaseManager.parsedConnectionString??]
    <tr> <td>Database type:</td> <td>${ctx.databaseManager.databaseType}</td> </tr>
    <tr> <td>Database URL:</td> <td><span class="mono mono-12px" style="white-space: pre">${ctx.databaseManager.connectionString}</span></td> </tr>
    <tr> <td>Database login:</td> <td>${ctx.databaseManager.parsedConnectionString.login!'(not specified)'}</td> </tr>
  [#else]
    <tr> <td>Database type:</td> <td>(no database settings)</td> </tr>
  [/#if]

  <tr> <td>Database is external:</td> <td>${ctx.isDatabaseExternal()?string('yes','no')}</td> </tr>
  <tr> <td>Database is accessible:</td> <td>${ctx.isDatabaseAccessible()?string('yes','no')}</td> </tr>
  <tr> <td>Database schema version:</td> <td>${ctx.databaseVersion} [#if ctx.databaseVersionIsGuessed](guessed)[/#if] </td> </tr>
  <tr> <td>Count of database tables:</td> <td>${ctx.countOfTables}</td> </tr>
  [#if ctx.databaseManager??]
      <tr> <td>Heartbeat status:</td> <td>${ctx.databaseManager.heartbeatStatus}</td> </tr>
      <tr> <td>Heartbeat is pulsing:</td> <td>${ctx.databaseManager.heartbeatPulsing?string('yes','no')}</td> </tr>
      <tr> <td>Heartbeat last pulse timestamp:</td> <td>[#if ctx.databaseManager.lastHeartbeatPulseTime??]${ctx.databaseManager.lastHeartbeatPulseTime?string("yyyy-MM-dd HH:mm:ss")}[#else]never[/#if]</td> </tr>
      [#if ctx.databaseManager.lastHeartbeatException??]
          <tr> <td>Heartbeat last exception:</td> <td>${ctx.databaseManager.lastHeartbeatException.message}</td> </tr>
      [#else]
          <tr> <td>Heartbeat last exception:</td> <td>no</td> </tr>
      [/#if]
  [/#if]
  <tr> <td>Backup is possible:</td> <td>${ctx.backupPossible?string('yes','no')}</td> </tr>
  <tr> <td>Count of admins logged in:</td> <td>${ctx.countOfAdminsLoggedIn}</td> </tr>
  <tr> <td>Development mode:</td> <td>${ctx.developmentMode?string('yes','no')}</td> </tr>
  <tr> <td>Bypass maintenance questions:</td> <td>${ctx.bypassingMaintenanceQuestions?string('yes','no')}</td> </tr>
  <tr> <td>Maintenance is asked:</td> <td>${ctx.maintenanceAsked?string('asked','not asked')}</td> </tr>
</table>
</div>

[#if ctx.hasExceptions()]
  <h3>Exceptions</h3>
  [#list ctx.exceptions as ex]
    <div class="info-section">
      <tt><b><font color="red">${ex.getClass().getSimpleName()}</font>:  ${ex.message}<br/></b></tt>
      <div style="margin-left: 1cm; font-size: smaller">
        [#list ex.stackTrace as st]
          <tt>${st.toString()}</tt>
        [/#list]
      </div>
    </div>
  [/#list]
[/#if]

[@loginfo/]

<h3>Stage Pages</h3>

<ul class="stages-list">
  [#list debug.allStages as stage]
    <li><span class="${stage.iconCode}"></span> ${stage.description} (<a href="${webPrefix}/mnt/debug/page/${stage.page}">${stage.page}</a>)</li>
  [/#list]
</ul>

[/#if]

[/#escape]
[/@maintenancePage]
